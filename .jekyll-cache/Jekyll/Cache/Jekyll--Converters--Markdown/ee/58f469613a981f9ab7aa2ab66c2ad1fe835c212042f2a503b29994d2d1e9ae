I"È!<p>å¦‚æœä½ åšè¿‡ iOS å¼€å‘é‚£ä½ è‚¯å®šçŸ¥é“ Runtimeï¼Œä½œä¸º Objective-C è¯­è¨€çš„åŸºçŸ³ï¼ŒRuntime æ¸—é€åˆ° iOS å¼€å‘çš„æ–¹æ–¹é¢é¢ã€‚ä»å‡½æ•°è°ƒç”¨åˆ°å†…å­˜ç®¡ç†ï¼Œå†åˆ°å¯¹è±¡æ„å»ºéƒ½ç¦»ä¸å¼€ Runtime çš„èº«å½±ã€‚</p>

<p>è¿™ç¯‡æ–‡ç« å°†ä»æ•´ä½“è§†è§’æ¦‚æ‹¬ä¸€ä¸‹ Runtime çš„å‡ ä¸ªè¯é¢˜ï¼š</p>

<ol>
  <li>Runtime æ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</li>
  <li>Runtime æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Ÿ</li>
  <li>æˆ‘ä»¬èƒ½ç”¨ Runtime åšä»€ä¹ˆï¼Ÿ</li>
</ol>

<!-- more -->

<p><img src="../../images/first/runtime.jpg" alt="" /></p>

<blockquote>
  <p>åˆ°å…¬ä¼—å·ã€iOSå¼€å‘æ ˆã€‘å­¦ä¹ æ›´å¤šSwiftUIã€iOSå¼€å‘ç›¸å…³å†…å®¹ã€‚</p>
</blockquote>

<h1 id="runtime">Runtime</h1>

<p>ä»å·¥ç¨‹å­¦çš„æœ¬è´¨ä¸Šè®² Runtime å°±æ˜¯ä¸€ä¸ªç”¨ C/C++ å†™çš„é¡¹ç›®ã€‚è¿™ä¸ªé¡¹ç›®è¢«ç”¨æ¥å®ç° Objective-C è¿™é—¨è¯­è¨€ï¼Œå¦‚æœä½ æƒ³çš„è¯ï¼Œå®ƒä¹Ÿå¯ä»¥ç”¨æ¥å®ç°å…¶ä»–è¯­è¨€ï¼ˆObjective-D ?)ã€‚</p>

<p>ç¼–ç¨‹è¯­è¨€å¯ä»¥åˆ†æˆæœºå™¨è¯­è¨€ï¼ˆäºŒè¿›åˆ¶ã€æ±‡ç¼–ï¼‰å’Œé«˜çº§è¯­è¨€ï¼ˆCã€Javaç­‰ï¼‰ï¼Œè¿™æ ·åˆ’åˆ†çš„æ ‡å‡†æ˜¯<em>æ˜¯å¦èƒ½å¤Ÿç›´æ¥è¢«æœºå™¨è¯†åˆ«</em>ã€‚é«˜çº§è¯­è¨€ä¹‹æ‰€ä»¥é«˜çº§æ˜¯å› ä¸ºèƒ½å¤Ÿç›´æ¥è¢«äººç±»è¯»æ‡‚ï¼Œè€Œä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹å°±è¦åšå‡ºæ—¶é—´ã€ç©ºé—´ä¸Šçš„ç‰ºç‰²ã€‚æ¯”æ–¹è¯´åœ¨é«˜çº§è¯­è¨€ä¸­å£°æ˜ä¸€ä¸ªç±»çš„è¯­è¨€å¤§æ¦‚æ˜¯<code class="language-plaintext highlighter-rouge">class A {}</code>ï¼Œè¿™æ ·ä¸€æ®µå­—æ¯äººèƒ½çœ‹æ‡‚ï¼Œæœºå™¨å´ä¸æ‡‚ï¼Œæ‰€ä»¥å°±è¦é€šè¿‡ä¸€ç³»åˆ—è½¬åŒ–æŠŠå®ƒå˜æˆæœºå™¨èƒ½æ‡‚çš„ä¸œè¥¿ â€”â€” ä¸€æ®µå†…å­˜ç©ºé—´ã€‚</p>

<p>åœ¨é«˜çº§è¯­è¨€ä¸­åˆå¯ä»¥åˆ†ä¸¤ä¸ªå±‚çº§ â€”â€” ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ï¼ˆsystem programming languageï¼‰å’Œéç³»ç»Ÿç¼–ç¨‹è¯­è¨€ã€‚ç³»ç»Ÿç¼–ç¨‹è¯­è¨€æ˜¯æŒ‡é‚£äº›éœ€è¦é€šè¿‡ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿ API æ¥å®ç°åŠŸèƒ½çš„è¯­è¨€ï¼Œæ¯”å¦‚ Cã€C++ã€Swiftã€Rustç­‰ã€‚è¿™ç±»è¯­è¨€ç”±äºéœ€è¦ç›´æ¥è·Ÿæ“ä½œç³»ç»Ÿæ‰“äº¤é“æ‰€ä»¥è¦æ ¹æ®æ“ä½œç³»ç»Ÿçš„ä¸åŒæ‰§è¡Œä¸åŒçš„è°ƒç”¨ï¼Œè€Œä¸”è¿™ç±»è¯­è¨€å› ä¸ºç¦»ç¡¬ä»¶â€œæ›´è¿‘â€æ‰€ä»¥æ˜¯æ›´åŠ â€œå±é™©çš„â€ï¼Œä¸€ä¸å°å¿ƒå°±å¯èƒ½å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚</p>

<p>ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ä¸€èˆ¬å¯ä»¥è‡ªå·±å®ç°è‡ªå·±ï¼Œè€Œéç³»ç»Ÿç¼–ç¨‹è¯­è¨€ä¸€èˆ¬éœ€è¦é€šè¿‡ç³»ç»Ÿç¼–ç¨‹è¯­è¨€æ¥å®ç°è¯­æ³•ã€‚OC å°±æ˜¯é€šè¿‡ C/C++ æ¥å®ç°çš„ï¼Œç”¨æ¥å®ç° OC çš„ä»£ç å°±åœ¨ Runtime åº“é‡Œé¢ã€‚å¯ä»¥ä»è‹¹æœçš„å¼€æºç½‘ç«™ä¸Šè·å–åˆ° Runtime çš„æºä»£ç  <a href="https://opensource.apple.com/tarballs/objc4/">objc4</a>ï¼ŒGNU ä¹Ÿæœ‰ä¸€ä»½å¦å¤–çš„å¼€æºå®ç°ã€‚æ‰“å¼€ objc4 çš„ä»£ç å¯ä»¥çœ‹åˆ°é‡Œé¢æœ€ä¸»è¦çš„æ–‡ä»¶å¤¹å°±æ˜¯ runtimeã€‚</p>

<p>è¿™é‡Œå¯èƒ½æœ‰ä¸€ä¸ªè¯¯åŒºï¼ŒRuntime å¹¶ä¸èƒ½å’Œ OC çš„åŠ¨æ€ç‰¹æ€§åˆ’ç­‰å·ï¼ˆRuntime != OC åŠ¨æ€ç‰¹æ€§ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœ objc4 çš„ä½œè€…æƒ³çš„è¯ï¼Œä»–å®Œå…¨å¯ä»¥æŠŠ Objc å®ç°æˆä¸€ä¸ªå®Œå…¨æ²¡æœ‰åŠ¨æ€èƒ½åŠ›çš„è¯­è¨€ã€‚è€Œ OC ä¹‹æ‰€ä»¥æ‹¥æœ‰ç›®å‰çš„è¿™äº›åŠ¨æ€ç‰¹æ€§ï¼Œæ˜¯ç”±äº Runtime ä¸­ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„æä¾›äº†åŠ¨æ€çš„èƒ½åŠ›ï¼ˆä¹Ÿå¯ä»¥ä¸æä¾›ï¼‰ã€‚</p>

<h1 id="æ—¥å¸¸ç”¨åˆ°çš„-runtime">æ—¥å¸¸ç”¨åˆ°çš„ Runtime</h1>

<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­æˆ‘ä»¬ä¸€ç›´éƒ½åœ¨ä½¿ç”¨ Runtime çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code class="language-Objc">// æ ¹æ® instance å¯¹è±¡æˆ–è€…ç±»åè·å¾—ä¸€ä¸ª class å¯¹è±¡
- (Class)class
+ (Class)class
// åˆ¤æ–­å½“å‰ instance/class å¯¹è±¡çš„ isa æŒ‡å‘æ˜¯ä¸æ˜¯ class/meta-class å¯¹è±¡æˆ–è€…å®ƒçš„å­ç±»ç±»å‹
- (BOOL)isKindOfClass:(Class)cls
+ (BOOL)isKindOfClass:(Class)cls
// åˆ¤æ–­å½“å‰ instance/class å¯¹è±¡çš„ isa æŒ‡å‘æ˜¯ä¸æ˜¯ class/meta-class å¯¹è±¡ç±»å‹
- (BOOL)isMemberOfClass:(Class)cls
+ (BOOL)isMemberOfClass:(Class)cls
// åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥æ¥æ”¶ç‰¹å®šæ¶ˆæ¯
- (BOOL)respondsToSelector:(SEL)sel
+ (BOOL)respondsToSelector:(SEL)sel
// åˆ¤æ–­å¯¹è±¡æ˜¯å¦å®ç°äº†ç‰¹å®šåè®®ä¸­å®šä¹‰çš„æ–¹æ³•
- (BOOL)conformsToProtocol:(Protocol *)protocol
+ (BOOL)conformsToProtocol:(Protocol *)protocol
// å¯ä»¥æ ¹æ®ä¸€ä¸ª SELï¼Œå¾—åˆ°è¯¥æ–¹æ³•çš„ IMP
- (IMP)methodForSelector:(SEL)sel
+ (IMP)methodForSelector:(SEL)sel
</code></pre>

<p>é™¤äº†é€šè¿‡ OC çš„æ–¹æ³•ï¼Œè¿˜å¯ä»¥ç›´æ¥è°ƒç”¨ Runtime åº“ä¸­çš„ C å‡½æ•°ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code class="language-C">/****** å…³è”å¯¹è±¡ç›¸å…³ ********/
// æ·»åŠ å…³è”å¯¹è±¡
void objc_setAssociatedObject(id object, const void * key, id value, objc_AssociationPolicy policy)
// è·å¾—å…³è”å¯¹è±¡
id objc_getAssociatedObject(id object, const void * key)
// ç§»é™¤æŒ‡å®š object çš„æ‰€æœ‰å…³è”å¯¹è±¡
void objc_removeAssociatedObjects(id object)

/***** å±æ€§ç›¸å…³ *********/
// è·å–ä¸€ä¸ªå±æ€§
objc_property_t class_getProperty(Class cls, const char *name)
// æ‹·è´å±æ€§åˆ—è¡¨ï¼ˆæœ€åéœ€è¦è°ƒç”¨ free é‡Šæ”¾ï¼‰
objc_property_t *class_copyPropertyList(Class cls, unsigned int *outCount)
// åŠ¨æ€æ·»åŠ å±æ€§
BOOL class_addProperty(Class cls, const char *name, const objc_property_attribute_t *attributes, unsigned int attributeCount)
// åŠ¨æ€æ›¿æ¢å±æ€§
void class_replaceProperty(Class cls, const char *name, const objc_property_attribute_t *attributes, unsigned int attributeCount)
// è·å–å±æ€§çš„ä¸€äº›ä¿¡æ¯
const char *property_getName(objc_property_t property)
const char *property_getAttributes(objc_property_t property)
</code></pre>

<p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤šã€‚</p>

<h1 id="runtime-ä½¿ç”¨">Runtime ä½¿ç”¨</h1>

<p>å¾ˆå¤š OC çš„è‘—åå¼€æºåº“éƒ½ç”¨åˆ°äº† Runtime æä¾›çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ MJExtension å­—å…¸è½¬æ¨¡å‹ã€‚</p>

<p>å®ç°ä¸€ä¸ªç®€æ˜“çš„å­—å…¸è½¬æ¨¡å‹</p>

<pre><code class="language-ObjC">@interface Person : NSObject &lt;NSSecureCoding&gt;

@property (nonatomic, copy) NSString *name;
@property (nonatomic) int age;

@end

unsigned count;
objc_property_t *properties;
// è·å–ç±»çš„å±æ€§ä¸ªæ•°å’Œå±æ€§æ•°ç»„
properties = class_copyPropertyList(Person.class, &amp;count);
NSDictionary *dict = @{@"home": @"beijing", @"name": @"ioså¼€å‘æ ˆ", @"age": @3};
Person *p = [[Person alloc] init];
for (int i = 0; i &lt; count; i++) {
    // è·å–å±æ€§å
    const char *name = property_getName(properties[i]);
    // char * è½¬æ¢æˆ NSString *
    NSString *name_s = [NSString stringWithCString:name encoding:NSASCIIStringEncoding];
    // ä»å­—å…¸ä¸­å–å‡ºå±æ€§åå¯¹åº”çš„å€¼
    id value = [dict valueForKey:name_s];
    // ä½¿ç”¨ KVC è®¾ç½®å±æ€§å€¼
    [p setValue:value forKey:name_s];
}
NSLog(@"p.name = %@ --- p.age = %d", p.name, p.age); // p.name = ioså¼€å‘æ ˆ --- p.age = 3
// é‡Šæ”¾ C å¯¹è±¡
free(properties);
</code></pre>

<p>å®ç°è‡ªåŠ¨è§£æ¡£å’Œå½’æ¡£</p>

<pre><code class="language-ObjC">- (void)encodeWithCoder:(NSCoder *)coder
{
    objc_property_t *properties;
    unsigned count;
    properties = class_copyPropertyList(Person.class, &amp;count);
    for (int i = 0; i &lt; count; i++) {
        objc_property_t property = properties[i];
        const char *name = property_getName(property);
        NSString *name_s = [NSString stringWithCString:name encoding:NSUTF8StringEncoding];
        id value = [self valueForKey:name_s];
        // æ­¤å¤„ä¸ºäº†ç®€åŒ–æ¼”ç¤ºé€»è¾‘ï¼Œå°±ç”¨ç¡¬ç¼–ç äº†
        if ([name_s isEqualToString:@"age"]) {
            [coder encodeInt:[value intValue] forKey:name_s];
        }
        else {
            [coder encodeObject:value forKey:name_s];
        }
    }
}

- (instancetype)initWithCoder:(NSCoder *)coder
{
    self = [super init];
    if (self) {
        objc_property_t *properties;
        unsigned count;
        properties = class_copyPropertyList(Person.class, &amp;count);
        for (int i = 0; i &lt; count; i++) {
            objc_property_t property = properties[i];
            const char *name = property_getName(property);
            NSString *name_s = [NSString stringWithCString:name encoding:NSUTF8StringEncoding];
            // æ­¤å¤„ä¸ºäº†ç®€åŒ–æ¼”ç¤ºé€»è¾‘ï¼Œå°±ç”¨ç¡¬ç¼–ç äº†
            if ([name_s isEqualToString:@"age"]) {
                [self setValue:@([coder decodeIntForKey:name_s]) forKey:name_s];
            }
            else {
                [self setValue:[coder decodeObjectForKey:name_s] forKey:name_s];
            }
        }
    }
    return self;
}
</code></pre>

<p>é™¤äº†ä¸Šé¢æ¼”ç¤ºçš„ä¸¤ä¸ªåŠŸèƒ½ä»¥å¤–ï¼Œruntime èƒ½åšçš„äº‹æƒ…è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¸¸ç”¨çš„ç»™åˆ†ç±»æ·»åŠ æ–¹æ³•ã€è¿è¡Œæ—¶ç»™ç±»æ·»åŠ æ–¹æ³•ï¼Œä»¥åŠæ¶ˆæ¯è½¬å‘ç­‰ç­‰ã€‚</p>

<blockquote>
  <p>åˆ°å…¬ä¼—å·ã€iOSå¼€å‘æ ˆã€‘å­¦ä¹ æ›´å¤šSwiftUIã€iOSå¼€å‘ç›¸å…³å†…å®¹ã€‚</p>
</blockquote>

<h1 id="æ€»ç»“">æ€»ç»“</h1>

<p>è¿™ç¯‡æ–‡ç« ä»æ€»ä½“è®¤è¯†ä¸€ä¸‹ Runtimeï¼Œå…¶å® Runtime çš„çŸ¥è¯†ç‚¹è¿˜æœ‰å¾ˆå¤šï¼Œåé¢æˆ‘ä¼šç”¨å¤šç¯‡æ–‡ç« æŠŠä¸»è¦çŸ¥è¯†ç‚¹éƒ½è¦†ç›–äº†ï¼Œå¸Œæœ›èƒ½å¤Ÿè®©ä½ å¯¹è¿™ä¸ªçŸ¥è¯†ç‚¹èä¼šè´¯é€šï¼Œå­¦ä»¥è‡´ç”¨ã€‚</p>

<p>å‚è€ƒé“¾æ¥ï¼š</p>

<p><a href="https://juejin.cn/post/6844904071480999949">æ·±å…¥æµ…å‡º Runtimeï¼ˆä¸€ï¼‰ï¼šåˆè¯†</a>
<a href="https://www.jianshu.com/p/2b98d77ce7c0">runtime è‡ªåŠ¨å½’æ¡£/è§£æ¡£</a></p>
:ET